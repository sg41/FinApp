{
    "info": {
        "_postman_id": "YOUR_UNIQUE_ID",
        "name": "FinApp API Tests",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "item": [
        {
            "name": "VBank Lifecycle (Auto-Approve)",
            "item": [
                {
                    "name": "Create VBank Connection",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\",function(){pm.response.to.have.status(200);});pm.test(\"Response is valid for create\",function(){const d=pm.response.json();pm.expect(d.status).to.be.oneOf([\"success_auto_approved\",\"already_initiated\"]);pm.expect(d).to.have.property(\"connection_id\");if(d.connection_id)pm.environment.set(\"connection_id_vbank\",d.connection_id);});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"bank_name\": \"vbank\",\n  \"bank_client_id\": \"{{team_id}}-1\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections"
                            ]
                        }
                    }
                },
                {
                    "name": "Refresh VBank Connection Data",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\",function(){pm.response.to.have.status(200);});pm.test(\"Response status is success_approved\",function(){const d=pm.response.json();pm.expect(d.status).to.eql(\"success_approved\");pm.expect(d).to.have.property(\"accounts_data\");});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections/{{connection_id_vbank}}",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections",
                                "{{connection_id_vbank}}"
                            ]
                        }
                    }
                },
                {
                    "name": "Delete VBank Connection",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\",function(){pm.response.to.have.status(200);});pm.test(\"Response confirms deletion\",function(){pm.expect(pm.response.json().status).to.eql(\"deleted\");});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "DELETE",
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections/{{connection_id_vbank}}",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections",
                                "{{connection_id_vbank}}"
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "ABank Lifecycle (Auto-Approve)",
            "item": [
                {
                    "name": "Create ABank Connection",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\",function(){pm.response.to.have.status(200);});pm.test(\"Response is valid for create\",function(){const d=pm.response.json();pm.expect(d.status).to.be.oneOf([\"success_auto_approved\",\"already_initiated\"]);pm.expect(d).to.have.property(\"connection_id\");if(d.connection_id)pm.environment.set(\"connection_id_abank\",d.connection_id);});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"bank_name\": \"abank\",\n  \"bank_client_id\": \"{{team_id}}-2\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections"
                            ]
                        }
                    }
                },
                {
                    "name": "Refresh ABank Connection Data",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\",function(){pm.response.to.have.status(200);});pm.test(\"Response status is success_approved\",function(){const d=pm.response.json();pm.expect(d.status).to.eql(\"success_approved\");pm.expect(d).to.have.property(\"accounts_data\");});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections/{{connection_id_abank}}",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections",
                                "{{connection_id_abank}}"
                            ]
                        }
                    }
                },
                {
                    "name": "Delete ABank Connection",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\",function(){pm.response.to.have.status(200);});pm.test(\"Response confirms deletion\",function(){pm.expect(pm.response.json().status).to.eql(\"deleted\");});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "DELETE",
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections/{{connection_id_abank}}",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections",
                                "{{connection_id_abank}}"
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "SBank Lifecycle (Manual Approve)",
            "item": [
                {
                    "name": "Create SBank Connection",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\",function(){pm.response.to.have.status(200);});pm.test(\"Response indicates manual approval and returns connection_id\",function(){const d=pm.response.json();pm.expect(d.status).to.be.oneOf([\"awaiting_authorization\",\"already_initiated\"]);pm.expect(d).to.have.property(\"connection_id\");if(d.connection_id)pm.environment.set(\"connection_id_sbank\",d.connection_id);});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"bank_name\": \"sbank\",\n  \"bank_client_id\": \"{{team_id}}-4\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections"
                            ]
                        }
                    }
                },
                {
                    "name": "Check SBank Consent Status",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\",function(){pm.response.to.have.status(200);});pm.test(\"Response has a valid status\",function(){const d=pm.response.json();pm.expect(d.status).to.be.a('string');console.log(\"Current consent status: \"+d.status);});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections/{{connection_id_sbank}}",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections",
                                "{{connection_id_sbank}}"
                            ]
                        }
                    }
                },
                {
                    "name": "Delete SBank Connection",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\",function(){pm.response.to.have.status(200);});pm.test(\"Response confirms deletion\",function(){pm.expect(pm.response.json().status).to.eql(\"deleted\");});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "DELETE",
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections/{{connection_id_sbank}}",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections",
                                "{{connection_id_sbank}}"
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "List & Filter Connections",
            "item": [
                {
                    "name": "Get All Connections",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 200\",function(){pm.response.to.have.status(200);});pm.test(\"Response is a valid connection list\",function(){const d=pm.response.json();pm.expect(d).to.have.property(\"count\");pm.expect(d).to.have.property(\"connections\").that.is.an('array');});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "GET",
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections"
                            ]
                        }
                    }
                },
                {
                    "name": "Advanced Filter Tests (with setup/teardown)",
                    "item": [
                        {
                            "name": "(SETUP) Create ABank Client for Filtering",
                            "event": [
                                {
                                    "listen": "test",
                                    "script": {
                                        "exec": [
                                            "pm.test(\"Status is 200\", function(){pm.response.to.have.status(200);});",
                                            "const d=pm.response.json();pm.test(\"Setup connection created\",function(){pm.expect(d.status).to.be.oneOf([\"success_auto_approved\",\"already_initiated\"]);pm.expect(d).to.have.property(\"connection_id\");});",
                                            "pm.environment.set(\"filter_test_connection_id\",d.connection_id);"
                                        ],
                                        "type": "text/javascript"
                                    }
                                }
                            ],
                            "request": {
                                "method": "POST",
                                "body": {
                                    "mode": "raw",
                                    "raw": "{\n  \"bank_name\": \"abank\",\n  \"bank_client_id\": \"{{team_id}}-5\"\n}",
                                    "options": {
                                        "raw": {
                                            "language": "json"
                                        }
                                    }
                                },
                                "url": {
                                    "raw": "{{base_url}}/users/{{user_id}}/connections",
                                    "host": [
                                        "{{base_url}}"
                                    ],
                                    "path": [
                                        "users",
                                        "{{user_id}}",
                                        "connections"
                                    ]
                                }
                            }
                        },
                        {
                            "name": "Filter by bank_client_id (Client Exists)",
                            "event": [
                                {
                                    "listen": "test",
                                    "script": {
                                        "exec": [
                                            "pm.test(\"Status is 200\", function(){pm.response.to.have.status(200);});",
                                            "pm.test(\"Finds exactly one connection\", function(){",
                                            "    const d = pm.response.json();",
                                            "    const expected_client_id = pm.environment.get(\"team_id\") + \"-5\";",
                                            "    pm.expect(d.count).to.eql(1);",
                                            "    pm.expect(d.connections[0].bank_client_id).to.eql(expected_client_id);",
                                            "});"
                                        ],
                                        "type": "text/javascript"
                                    }
                                }
                            ],
                            "request": {
                                "method": "GET",
                                "url": {
                                    "raw": "{{base_url}}/users/{{user_id}}/connections?bank_client_id={{team_id}}-5",
                                    "host": [
                                        "{{base_url}}"
                                    ],
                                    "path": [
                                        "users",
                                        "{{user_id}}",
                                        "connections"
                                    ],
                                    "query": [
                                        {
                                            "key": "bank_client_id",
                                            "value": "{{team_id}}-5"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "name": "Filter by bank_name AND bank_client_id (Client Exists)",
                            "event": [
                                {
                                    "listen": "test",
                                    "script": {
                                        "exec": [
                                            "pm.test(\"Status is 200\", function(){pm.response.to.have.status(200);});",
                                            "pm.test(\"Finds exactly one connection with correct properties\", function(){",
                                            "    const d = pm.response.json();",
                                            "    const expected_client_id = pm.environment.get(\"team_id\") + \"-5\";",
                                            "    pm.expect(d.count).to.eql(1);",
                                            "    pm.expect(d.connections[0].bank_name).to.eql(\"abank\");",
                                            "    pm.expect(d.connections[0].bank_client_id).to.eql(expected_client_id);",
                                            "});"
                                        ],
                                        "type": "text/javascript"
                                    }
                                }
                            ],
                            "request": {
                                "method": "GET",
                                "url": {
                                    "raw": "{{base_url}}/users/{{user_id}}/connections?bank_name=abank&bank_client_id={{team_id}}-5",
                                    "host": [
                                        "{{base_url}}"
                                    ],
                                    "path": [
                                        "users",
                                        "{{user_id}}",
                                        "connections"
                                    ],
                                    "query": [
                                        {
                                            "key": "bank_name",
                                            "value": "abank"
                                        },
                                        {
                                            "key": "bank_client_id",
                                            "value": "{{team_id}}-5"
                                        }
                                    ]
                                }
                            }
                        },
                        {
                            "name": "(TEARDOWN) Delete ABank Client for Filtering",
                            "event": [
                                {
                                    "listen": "test",
                                    "script": {
                                        "exec": [
                                            "pm.test(\"Status is 200\",function(){pm.response.to.have.status(200);});",
                                            "pm.test(\"Response confirms deletion\",function(){pm.expect(pm.response.json().status).to.eql(\"deleted\");});"
                                        ],
                                        "type": "text/javascript"
                                    }
                                }
                            ],
                            "request": {
                                "method": "DELETE",
                                "url": {
                                    "raw": "{{base_url}}/users/{{user_id}}/connections/{{filter_test_connection_id}}",
                                    "host": [
                                        "{{base_url}}"
                                    ],
                                    "path": [
                                        "users",
                                        "{{user_id}}",
                                        "connections",
                                        "{{filter_test_connection_id}}"
                                    ]
                                }
                            }
                        },
                        {
                            "name": "Filter by bank_client_id (Client Deleted)",
                            "event": [
                                {
                                    "listen": "test",
                                    "script": {
                                        "exec": [
                                            "pm.test(\"Status is 200\",function(){pm.response.to.have.status(200);});",
                                            "pm.test(\"Finds zero connections\",function(){const d=pm.response.json();pm.expect(d.count).to.eql(0);pm.expect(d.connections).to.be.an('array').that.is.empty;});"
                                        ],
                                        "type": "text/javascript"
                                    }
                                }
                            ],
                            "request": {
                                "method": "GET",
                                "url": {
                                    "raw": "{{base_url}}/users/{{user_id}}/connections?bank_client_id={{team_id}}-5",
                                    "host": [
                                        "{{base_url}}"
                                    ],
                                    "path": [
                                        "users",
                                        "{{user_id}}",
                                        "connections"
                                    ],
                                    "query": [
                                        {
                                            "key": "bank_client_id",
                                            "value": "{{team_id}}-5"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                }
            ]
        },
        {
            "name": "Edge Cases and Errors",
            "item": [
                {
                    "name": "Create Connection (Invalid bank_name)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 404\",function(){pm.response.to.have.status(404);});pm.test(\"Error message is correct\",function(){pm.expect(pm.response.json().detail).to.include(\"not supported\");});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"bank_name\": \"wrongbank\",\n  \"bank_client_id\": \"{{team_id}}-1\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections"
                            ]
                        }
                    }
                },
                {
                    "name": "Create Connection (Non-existent user_id)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 404\",function(){pm.response.to.have.status(404);});pm.test(\"Error message is correct\",function(){pm.expect(pm.response.json().detail).to.eql(\"User not found\");});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"bank_name\": \"vbank\",\n  \"bank_client_id\": \"{{team_id}}-1\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/users/999/connections",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "999",
                                "connections"
                            ]
                        }
                    }
                },
                {
                    "name": "Create Connection (Invalid body)",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 422\",function(){pm.response.to.have.status(422);});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "body": {
                            "mode": "raw",
                            "raw": "{\n  \"bank_name\": \"vbank\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections"
                            ]
                        }
                    }
                },
                {
                    "name": "Delete Non-existent Connection",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "pm.test(\"Status code is 404\",function(){pm.response.to.have.status(404);});"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "DELETE",
                        "url": {
                            "raw": "{{base_url}}/users/{{user_id}}/connections/9999",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "users",
                                "{{user_id}}",
                                "connections",
                                "9999"
                            ]
                        }
                    }
                }
            ]
        }
    ]
}